<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dr. Robert O. Young - AI Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #1a1a1a;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #e0e0e0;
        }

        /* Top Bar */
        .topbar {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid #2a2a2a;
            background: #1a1a1a;
            flex-shrink: 0;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 22px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
            line-height: 1;
        }

        .menu-btn:hover { background: #2a2a2a; }

        /* Chat Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        .chat-area::-webkit-scrollbar { width: 4px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* Welcome Screen */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-icon {
            width: 64px;
            height: 64px;
            background: #2a2a2a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .welcome h2 {
            color: #e0e0e0;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome p {
            color: #777;
            font-size: 14px;
        }

        /* Messages */
        .messages-container {
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .msg {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            max-width: 100%;
            animation: msgSlide 0.3s ease;
        }

        @keyframes msgSlide {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.user {
            flex-direction: row-reverse;
        }

        .msg.bot {
            flex-direction: row;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
            font-weight: normal;
        }

        .user .avatar {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }

        .bot .avatar {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            border: 1px solid #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .avatar:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }

        .msg-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-width: 75%;
        }

        .msg.user .msg-bubble {
            background: #7c3aed;
            color: #fff;
            border-bottom-right-radius: 4px;
        }

        .msg.user .msg-bubble {
            max-width: 70%;
        }

        .msg.bot .msg-bubble {
            background: #2a2a2a;
            color: #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .msg-bubble.error {
            background: #3a1a1a;
            color: #f87171;
        }

        .msg-time {
            font-size: 10px;
            color: #555;
            margin-top: 4px;
            padding: 0 4px;
        }

        .msg.user .msg-time { text-align: right; }

        /* Typing Indicator */
        .typing {
            align-self: flex-start;
            animation: msgSlide 0.3s ease;
        }

        .typing-dots {
            background: #2a2a2a;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            padding: 14px 18px;
            display: flex;
            gap: 5px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #555;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.15s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.3s; }

        @keyframes bounce {
            0%, 55%, 100% { transform: translateY(0); opacity: 0.4; }
            25% { transform: translateY(-5px); opacity: 1; }
        }

        /* Input Area */
        .input-area {
            padding: 12px 16px 16px;
            background: #1a1a1a;
            flex-shrink: 0;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .input-box {
            background: #2a2a2a;
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #question {
            width: 100%;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 14px;
            outline: none;
            resize: none;
        }

        #question::placeholder { color: #666; }

        .input-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-left {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .input-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover { color: #999; background: #333; }

        .action-btn svg {
            width: 18px;
            height: 18px;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        #send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #7c3aed;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #send-btn:hover:not(:disabled) {
            background: #6d28d9;
            transform: scale(1.05);
        }

        #send-btn:disabled {
            background: #333;
            color: #555;
            cursor: not-allowed;
        }

        #send-btn svg {
            width: 16px;
            height: 16px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Suggestion Chips */
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 24px;
            justify-content: center;
            max-width: 460px;
        }

        .chip {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 20px;
            color: #999;
            font-size: 12.5px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .chip:hover {
            background: #333;
            color: #ccc;
            border-color: #444;
        }

        /* Mic recording state */
        #mic-btn.recording {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
            animation: micPulse 1s infinite;
        }

        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        /* Mobile */
        @media (max-width: 640px) {
            .messages-container { padding: 16px 12px; }
            .msg { max-width: 90%; }
            #question { font-size: 16px; }
            .welcome-icon { width: 56px; height: 56px; font-size: 24px; }
            .welcome h2 { font-size: 18px; }
            .suggestions { gap: 6px; max-width: 320px; }
            .chip { font-size: 12px; padding: 7px 14px; }
            .chat-area::-webkit-scrollbar { display: none; }
            .chat-area { -ms-overflow-style: none; scrollbar-width: none; }
        }

        @media (max-width: 380px) {
            .welcome h2 { font-size: 16px; }
            .welcome p { font-size: 13px; }
            .chip { font-size: 11.5px; }
        }
    </style>
</head>

<body>

<!-- Top Bar -->
<div class="topbar">
    <button class="menu-btn">&#9776;</button>
</div>

<!-- Chat Area -->
<div class="chat-area" id="chatArea">
    <div class="welcome" id="welcome">
        <div class="welcome-icon">ðŸ‘‹</div>
        <h2>Welcome to Chat Bot</h2>
        <p>Your AI-powered assistant. Ask me anything!</p>
        <div class="suggestions">
            <button class="chip" onclick="askSuggestion(this)">What is MasterPeace Zeolite?</button>
            <button class="chip" onclick="askSuggestion(this)">Benefits of alkaline diet</button>
            <button class="chip" onclick="askSuggestion(this)">How does acidity affect health?</button>
            <button class="chip" onclick="askSuggestion(this)">What is fog water contamination?</button>
        </div>
    </div>
</div>

<!-- Input Area -->
<div class="input-area">
    <div class="input-box">
        <input id="question" placeholder="Message Chat Bot" autocomplete="off" />
        <div class="input-actions">
            <div class="input-left"></div>
            <div class="input-right">
                <!-- Mic -->
                <button class="action-btn" id="mic-btn" title="Voice input">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
                        <path d="M19 10v2a7 7 0 01-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </button>
                <!-- Send -->
                <button id="send-btn" title="Send message">
                    <svg viewBox="0 0 24 24">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const chatArea = document.getElementById("chatArea");
const questionInput = document.getElementById("question");
const sendBtn = document.getElementById("send-btn");
const conversationId = "conv_" + Date.now();

let messagesContainer = null;

function getTime() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function getMessagesContainer() {
    if (!messagesContainer) {
        messagesContainer = document.createElement("div");
        messagesContainer.className = "messages-container";
        chatArea.appendChild(messagesContainer);
    }
    return messagesContainer;
}

function askSuggestion(el) {
    questionInput.value = el.textContent;
    sendMessage();
}

function addMessage(text, sender) {
    const welcome = document.getElementById("welcome");
    if (welcome) welcome.remove();

    const container = getMessagesContainer();

    const msg = document.createElement("div");
    msg.className = `msg ${sender}`;

    // Create avatar with icons
    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = sender === "user" ? "ðŸ‘¤" : "ðŸ¤–";

    const bubbleContainer = document.createElement("div");
    bubbleContainer.style.display = "flex";
    bubbleContainer.style.flexDirection = "column";
    bubbleContainer.style.alignItems = sender === "user" ? "flex-end" : "flex-start";
    bubbleContainer.style.maxWidth = "75%";

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble";
    
    // For user messages, keep as single line
    // For bot messages, convert URLs to clickable links
    if (sender === "user") {
        bubble.textContent = text;
        bubble.style.whiteSpace = "nowrap";
        bubble.style.overflow = "hidden";
        bubble.style.textOverflow = "ellipsis";
        bubble.title = text; // Show full text on hover
    } else {
        // Convert URLs in bot responses to clickable links - Enhanced formatting
        console.log("=== ENHANCED URL PROCESSING ===");
        console.log("Original text:", text);
        
        // Find all URLs
        const urlRegex = /https?:\/\/[^\s\)]+/g;
        const urls = text.match(urlRegex);
        
        if (urls && urls.length > 0) {
            console.log("Found URLs:", urls);
            
            // Create clean response with properly formatted URLs
            let lines = text.split('\n');
            let cleanLines = [];
            let inUrlSection = false;
            let urlLines = [];
            
            // Process line by line
            for (let line of lines) {
                line = line.trim();
                
                if (line.includes('See here for more info:') || line.includes('Learn more here:')) {
                    cleanLines.push(line);
                    inUrlSection = true;
                    continue;
                }
                
                if (inUrlSection && urlRegex.test(line)) {
                    // This is a URL line - separate concatenated URLs
                    let urlLine = line;
                    // Add line breaks between concatenated URLs
                    urlLine = urlLine.replace(/(https?:\/\/[^\s]*?)(?=https?:\/\/)/g, '$1\n');
                    const separatedUrls = urlLine.split('\n').filter(url => url.trim());
                    urlLines.push(...separatedUrls);
                } else if (inUrlSection && (line === '' || line.startsWith('References:'))) {
                    // Stop processing after URLs
                    break;
                } else if (inUrlSection) {
                    // Content after URLs - ignore it
                    break;
                } else if (line && !line.startsWith('Answer With AI:')) {
                    // Regular content line (excluding the "Answer With AI:" prefix)
                    cleanLines.push(line);
                }
            }
            
            // Build final result with better formatting
            let result = '';
            
            // Add main content
            if (cleanLines.length > 0) {
                result += cleanLines.join('\n') + '\n\n';
            }
            
            // Add properly formatted URLs section
            if (urlLines.length > 0) {
                result += 'See here for more info:\n';
                urlLines.forEach((url, index) => {
                    if (url.trim()) {
                        result += `<a href="${url.trim()}" target="_blank" style="color: #a78bfa; text-decoration: underline; display: block; margin: 5px 0;">${url.trim()}</a>\n`;
                    }
                });
            }
            
            console.log("Final clean result:", result);
            bubble.innerHTML = result;
        } else {
            console.log("No URLs found in response");
            bubble.textContent = text;
        }
        
        console.log("=== END PROCESSING ===");
    }

    const time = document.createElement("div");
    time.className = "msg-time";
    time.textContent = getTime();
    time.style.marginTop = "4px";
    time.style.padding = "0 4px";

    bubbleContainer.appendChild(bubble);
    bubbleContainer.appendChild(time);

    msg.appendChild(avatar);
    msg.appendChild(bubbleContainer);
    container.appendChild(msg);
    chatArea.scrollTop = chatArea.scrollHeight;

    return bubble;
}

function showTyping() {
    const container = getMessagesContainer();

    const typing = document.createElement("div");
    typing.className = "msg bot";
    typing.id = "typing-indicator";

    // Create AI avatar
    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = "ðŸ¤–";

    const bubbleContainer = document.createElement("div");
    bubbleContainer.style.display = "flex";
    bubbleContainer.style.flexDirection = "column";
    bubbleContainer.style.alignItems = "flex-start";
    bubbleContainer.style.maxWidth = "75%";

    const dots = document.createElement("div");
    dots.className = "typing-dots";
    dots.innerHTML = "<span></span><span></span><span></span>";

    bubbleContainer.appendChild(dots);
    typing.appendChild(avatar);
    typing.appendChild(bubbleContainer);
    container.appendChild(typing);
    chatArea.scrollTop = chatArea.scrollHeight;
}

function removeTyping() {
    const typing = document.getElementById("typing-indicator");
    if (typing) typing.remove();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatBotResponse(text) {
    // Step 1: Separate concatenated URLs (https://a.comhttps://b.com â†’ separate lines)
    text = text.replace(/(https?:\/\/[^\s]+?)(https?:\/\/)/g, '$1\n$2');

    // Step 2: Split into URL and non-URL segments, make URLs clickable
    const urlPattern = /(https?:\/\/[^\s\)]+)/g;
    let result = '';
    let lastIndex = 0;
    let match;

    while ((match = urlPattern.exec(text)) !== null) {
        // Escaped text before URL
        result += escapeHtml(text.substring(lastIndex, match.index));
        // Clickable hyperlink
        let url = match[1];
        result += '<a href="' + url + '" target="_blank" ' +
                  'style="color: #a78bfa; text-decoration: underline; display: inline-block; margin: 3px 0; word-break: break-all;">' +
                  escapeHtml(url) + '</a>';
        lastIndex = urlPattern.lastIndex;
    }
    // Remaining text after last URL
    result += escapeHtml(text.substring(lastIndex));

    // Step 3: Newlines to <br>
    result = result.replace(/\n/g, '<br>');

    return result;
}

async function sendMessage() {
    const question = questionInput.value.trim();
    if (!question) return;

    addMessage(question, "user");
    questionInput.value = "";
    sendBtn.disabled = true;
    questionInput.disabled = true;

    showTyping();

    try {
        const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                question: question,
                conversation_id: conversationId
            })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        removeTyping();
        const botBubble = addMessage("", "bot");

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let accumulatedText = "";

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            accumulatedText += chunk;
            botBubble.innerHTML = formatBotResponse(accumulatedText);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        if (!accumulatedText.trim()) {
            botBubble.textContent = "No response received. Please try again.";
            botBubble.classList.add("error");
        }

    } catch (err) {
        removeTyping();
        console.error("Fetch error:", err);
        const errorBubble = addMessage(`Error: ${err.message}`, "bot");
        errorBubble.classList.add("error");
    }

    sendBtn.disabled = false;
    questionInput.disabled = false;
    questionInput.focus();
}

sendBtn.addEventListener("click", sendMessage);
questionInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

// Voice input using Web Speech API
const micBtn = document.getElementById("mic-btn");
let recognition = null;
let isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
        isRecording = true;
        micBtn.classList.add("recording");
    };

    recognition.onresult = (event) => {
        let transcript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        questionInput.value = transcript;
    };

    recognition.onend = () => {
        isRecording = false;
        micBtn.classList.remove("recording");
    };

    recognition.onerror = (event) => {
        isRecording = false;
        micBtn.classList.remove("recording");
        if (event.error !== 'no-speech') {
            console.error("Speech recognition error:", event.error);
        }
    };

    micBtn.addEventListener("click", () => {
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
        }
    });
} else {
    micBtn.style.display = "none";
}

// Mobile: handle virtual keyboard resize
if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", () => {
        document.body.style.height = window.visualViewport.height + "px";
        chatArea.scrollTop = chatArea.scrollHeight;
    });
}
</script>
</body>
</html>
